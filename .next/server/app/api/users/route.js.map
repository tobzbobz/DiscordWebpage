{"version":3,"file":"app/api/users/route.js","mappings":"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","sources":["webpack://_N_E/external commonjs \"node:async_hooks\"","webpack://_N_E/external commonjs \"node:buffer\"","webpack://_N_E/./app/api/users/route.js","webpack://_N_E/./app/api/users/route.js?4f20","webpack://_N_E/?f1ee","webpack://_N_E/./lib/db.ts"],"sourcesContent":["module.exports = require(\"node:async_hooks\");","module.exports = require(\"node:buffer\");","import { upsertUser, getActiveUsers, getUser } from '../../../lib/db';\r\n\r\nexport const runtime = 'edge';\r\n\r\n// GET - Fetch users\r\nexport async function GET(request) {\r\n  try {\r\n    const { searchParams } = new URL(request.url);\r\n    const discordId = searchParams.get('discordId');\r\n    const activeOnly = searchParams.get('active');\r\n    \r\n    if (discordId) {\r\n      const user = await getUser(discordId);\r\n      return Response.json({ success: true, user });\r\n    } else if (activeOnly === 'true') {\r\n      const users = await getActiveUsers();\r\n      return Response.json({ success: true, users });\r\n    } else {\r\n      return Response.json({ success: false, error: 'Missing parameters' }, { status: 400 });\r\n    }\r\n  } catch (error) {\r\n    console.error('GET users error:', error);\r\n    return Response.json({ success: false, error: error.message }, { status: 500 });\r\n  }\r\n}\r\n\r\n// POST - Create/update user (login)\r\nexport async function POST(request) {\r\n  try {\r\n    const body = await request.json();\r\n    const { discordId, discordUsername, callsign, vehicle } = body;\r\n    \r\n    if (!discordId) {\r\n      return Response.json({ success: false, error: 'Missing discordId' }, { status: 400 });\r\n    }\r\n    \r\n    const user = await upsertUser(\r\n      discordId,\r\n      discordUsername || '',\r\n      callsign || '',\r\n      vehicle || ''\r\n    );\r\n    \r\n    return Response.json({ success: true, user });\r\n  } catch (error) {\r\n    console.error('POST user error:', error);\r\n    return Response.json({ success: false, error: error.message }, { status: 500 });\r\n  }\r\n}\r\n","import { AppRouteRouteModule } from \"next/dist/server/future/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/server/future/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/server/lib/patch-fetch\";\nimport * as userland from \"C:\\\\Users\\\\Toby\\\\Downloads\\\\node-v24.11.1-win-x64\\\\app123\\\\app\\\\api\\\\users\\\\route.js\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/users/route\",\n        pathname: \"/api/users\",\n        filename: \"route\",\n        bundlePath: \"app/api/users/route\"\n    },\n    resolvedPagePath: \"C:\\\\Users\\\\Toby\\\\Downloads\\\\node-v24.11.1-win-x64\\\\app123\\\\app\\\\api\\\\users\\\\route.js\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks } = routeModule;\nconst originalPathname = \"/api/users/route\";\nfunction patchFetch() {\n    return _patchFetch({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\nexport { routeModule, requestAsyncStorage, staticGenerationAsyncStorage, serverHooks, originalPathname, patchFetch,  };\n\n//# sourceMappingURL=app-route.js.map","import { EdgeRouteModuleWrapper } from \"next/dist/server/web/edge-route-module-wrapper\";\n// Import the userland code.\nimport * as module from \"next-app-loader?name=app%2Fapi%2Fusers%2Froute&page=%2Fapi%2Fusers%2Froute&pagePath=private-next-app-dir%2Fapi%2Fusers%2Froute.js&appDir=C%3A%5CUsers%5CToby%5CDownloads%5Cnode-v24.11.1-win-x64%5Capp123%5Capp&appPaths=%2Fapi%2Fusers%2Froute&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!private-next-app-dir/api/users/route.js?__next_edge_ssr_entry__\";\nexport const ComponentMod = module;\nexport default EdgeRouteModuleWrapper.wrap(module.routeModule);\n\n//# sourceMappingURL=edge-app-route.js.map","import { neon } from '@neondatabase/serverless';\r\n\r\n// Get the database connection\r\nexport function getDb() {\r\n  if (!process.env.DATABASE_URL) {\r\n    throw new Error('DATABASE_URL environment variable is not set');\r\n  }\r\n  return neon(process.env.DATABASE_URL);\r\n}\r\n\r\n// Initialize database tables\r\nexport async function initializeDatabase() {\r\n  const sql = getDb();\r\n  \r\n  // Create users table\r\n  await sql`\r\n    CREATE TABLE IF NOT EXISTS users (\r\n      id SERIAL PRIMARY KEY,\r\n      discord_id VARCHAR(255) UNIQUE NOT NULL,\r\n      discord_username VARCHAR(255),\r\n      callsign VARCHAR(100),\r\n      vehicle VARCHAR(100),\r\n      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n      last_login TIMESTAMP DEFAULT CURRENT_TIMESTAMP\r\n    )\r\n  `;\r\n  \r\n  // Create eprf_records table (main ePRF tracking)\r\n  await sql`\r\n    CREATE TABLE IF NOT EXISTS eprf_records (\r\n      id SERIAL PRIMARY KEY,\r\n      incident_id VARCHAR(255) NOT NULL,\r\n      patient_letter CHAR(1) NOT NULL,\r\n      status VARCHAR(20) DEFAULT 'incomplete',\r\n      author_discord_id VARCHAR(255) NOT NULL,\r\n      author_callsign VARCHAR(100),\r\n      fleet_id VARCHAR(100),\r\n      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n      submitted_at TIMESTAMP,\r\n      UNIQUE(incident_id, patient_letter)\r\n    )\r\n  `;\r\n  \r\n  // Create eprf_data table (stores all form data as JSON)\r\n  await sql`\r\n    CREATE TABLE IF NOT EXISTS eprf_data (\r\n      id SERIAL PRIMARY KEY,\r\n      incident_id VARCHAR(255) NOT NULL,\r\n      patient_letter CHAR(1) NOT NULL,\r\n      section VARCHAR(50) NOT NULL,\r\n      data JSONB NOT NULL,\r\n      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n      UNIQUE(incident_id, patient_letter, section)\r\n    )\r\n  `;\r\n  \r\n  // Create indexes for faster queries\r\n  await sql`CREATE INDEX IF NOT EXISTS idx_eprf_records_author ON eprf_records(author_discord_id)`;\r\n  await sql`CREATE INDEX IF NOT EXISTS idx_eprf_records_status ON eprf_records(status)`;\r\n  await sql`CREATE INDEX IF NOT EXISTS idx_eprf_data_incident ON eprf_data(incident_id, patient_letter)`;\r\n  \r\n  return { success: true };\r\n}\r\n\r\n// ePRF Record operations\r\nexport async function createEPRFRecord(\r\n  incidentId: string,\r\n  patientLetter: string,\r\n  authorDiscordId: string,\r\n  authorCallsign: string,\r\n  fleetId: string\r\n) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    INSERT INTO eprf_records (incident_id, patient_letter, author_discord_id, author_callsign, fleet_id)\r\n    VALUES (${incidentId}, ${patientLetter}, ${authorDiscordId}, ${authorCallsign}, ${fleetId})\r\n    ON CONFLICT (incident_id, patient_letter) \r\n    DO UPDATE SET updated_at = CURRENT_TIMESTAMP\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0];\r\n}\r\n\r\nexport async function getEPRFRecord(incidentId: string, patientLetter: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT * FROM eprf_records \r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n  `;\r\n  \r\n  return result[0] || null;\r\n}\r\n\r\nexport async function getEPRFRecordsByUser(discordId: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT * FROM eprf_records \r\n    WHERE author_discord_id = ${discordId}\r\n    ORDER BY created_at DESC\r\n  `;\r\n  \r\n  return result;\r\n}\r\n\r\nexport async function getEPRFRecordsByStatus(discordId: string, status: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT * FROM eprf_records \r\n    WHERE author_discord_id = ${discordId} AND status = ${status}\r\n    ORDER BY created_at DESC\r\n  `;\r\n  \r\n  return result;\r\n}\r\n\r\nexport async function markEPRFComplete(incidentId: string, patientLetter: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    UPDATE eprf_records \r\n    SET status = 'complete', submitted_at = CURRENT_TIMESTAMP, updated_at = CURRENT_TIMESTAMP\r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0];\r\n}\r\n\r\nexport async function deleteEPRFRecord(incidentId: string, patientLetter: string) {\r\n  const sql = getDb();\r\n  \r\n  // Delete data first (foreign key would normally handle this)\r\n  await sql`\r\n    DELETE FROM eprf_data \r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n  `;\r\n  \r\n  // Then delete the record\r\n  const result = await sql`\r\n    DELETE FROM eprf_records \r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n    AND status = 'incomplete'\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0] || null;\r\n}\r\n\r\nexport async function transferEPRF(\r\n  incidentId: string,\r\n  patientLetter: string,\r\n  newAuthorDiscordId: string,\r\n  newAuthorCallsign: string\r\n) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    UPDATE eprf_records \r\n    SET author_discord_id = ${newAuthorDiscordId}, \r\n        author_callsign = ${newAuthorCallsign},\r\n        updated_at = CURRENT_TIMESTAMP\r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0];\r\n}\r\n\r\n// ePRF Data operations (form data)\r\nexport async function saveEPRFData(\r\n  incidentId: string,\r\n  patientLetter: string,\r\n  section: string,\r\n  data: any\r\n) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    INSERT INTO eprf_data (incident_id, patient_letter, section, data)\r\n    VALUES (${incidentId}, ${patientLetter}, ${section}, ${JSON.stringify(data)})\r\n    ON CONFLICT (incident_id, patient_letter, section) \r\n    DO UPDATE SET data = ${JSON.stringify(data)}, updated_at = CURRENT_TIMESTAMP\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0];\r\n}\r\n\r\nexport async function getEPRFData(incidentId: string, patientLetter: string, section: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT data FROM eprf_data \r\n    WHERE incident_id = ${incidentId} \r\n    AND patient_letter = ${patientLetter} \r\n    AND section = ${section}\r\n  `;\r\n  \r\n  return result[0]?.data || null;\r\n}\r\n\r\nexport async function getAllEPRFData(incidentId: string, patientLetter: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT section, data FROM eprf_data \r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n  `;\r\n  \r\n  // Convert to object with section names as keys\r\n  const dataObj: { [key: string]: any } = {};\r\n  for (const row of result) {\r\n    dataObj[row.section] = row.data;\r\n  }\r\n  \r\n  return dataObj;\r\n}\r\n\r\n// User operations\r\nexport async function upsertUser(\r\n  discordId: string,\r\n  discordUsername: string,\r\n  callsign: string,\r\n  vehicle: string\r\n) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    INSERT INTO users (discord_id, discord_username, callsign, vehicle, last_login)\r\n    VALUES (${discordId}, ${discordUsername}, ${callsign}, ${vehicle}, CURRENT_TIMESTAMP)\r\n    ON CONFLICT (discord_id) \r\n    DO UPDATE SET \r\n      discord_username = ${discordUsername},\r\n      callsign = ${callsign},\r\n      vehicle = ${vehicle},\r\n      last_login = CURRENT_TIMESTAMP\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0];\r\n}\r\n\r\nexport async function getActiveUsers() {\r\n  const sql = getDb();\r\n  \r\n  // Get users who logged in within the last 24 hours\r\n  const result = await sql`\r\n    SELECT * FROM users \r\n    WHERE last_login > NOW() - INTERVAL '24 hours'\r\n    ORDER BY last_login DESC\r\n  `;\r\n  \r\n  return result;\r\n}\r\n\r\nexport async function getUser(discordId: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT * FROM users WHERE discord_id = ${discordId}\r\n  `;\r\n  \r\n  return result[0] || null;\r\n}\r\n\r\n// Search and filter ePRFs\r\nexport async function searchEPRFs(\r\n  discordId: string,\r\n  query?: string,\r\n  status?: string,\r\n  dateFrom?: string,\r\n  dateTo?: string\r\n) {\r\n  const sql = getDb();\r\n  \r\n  let result;\r\n  \r\n  if (status && status !== 'all') {\r\n    if (query) {\r\n      result = await sql`\r\n        SELECT * FROM eprf_records \r\n        WHERE author_discord_id = ${discordId}\r\n        AND status = ${status}\r\n        AND (incident_id ILIKE ${'%' + query + '%'} OR patient_letter ILIKE ${'%' + query + '%'})\r\n        ORDER BY created_at DESC\r\n      `;\r\n    } else {\r\n      result = await sql`\r\n        SELECT * FROM eprf_records \r\n        WHERE author_discord_id = ${discordId}\r\n        AND status = ${status}\r\n        ORDER BY created_at DESC\r\n      `;\r\n    }\r\n  } else {\r\n    if (query) {\r\n      result = await sql`\r\n        SELECT * FROM eprf_records \r\n        WHERE author_discord_id = ${discordId}\r\n        AND (incident_id ILIKE ${'%' + query + '%'} OR patient_letter ILIKE ${'%' + query + '%'})\r\n        ORDER BY created_at DESC\r\n      `;\r\n    } else {\r\n      result = await sql`\r\n        SELECT * FROM eprf_records \r\n        WHERE author_discord_id = ${discordId}\r\n        ORDER BY created_at DESC\r\n      `;\r\n    }\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n// Admin functions - get ALL ePRF records\r\nexport async function getAllEPRFRecords(\r\n  query?: string,\r\n  status?: string,\r\n  authorId?: string\r\n) {\r\n  const sql = getDb();\r\n  \r\n  let result;\r\n  \r\n  // Build query based on filters\r\n  if (authorId && status && status !== 'all') {\r\n    if (query) {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.author_discord_id = ${authorId}\r\n        AND r.status = ${status}\r\n        AND (r.incident_id ILIKE ${'%' + query + '%'} OR r.patient_letter ILIKE ${'%' + query + '%'} OR r.author_callsign ILIKE ${'%' + query + '%'})\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    } else {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.author_discord_id = ${authorId}\r\n        AND r.status = ${status}\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    }\r\n  } else if (authorId) {\r\n    if (query) {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.author_discord_id = ${authorId}\r\n        AND (r.incident_id ILIKE ${'%' + query + '%'} OR r.patient_letter ILIKE ${'%' + query + '%'} OR r.author_callsign ILIKE ${'%' + query + '%'})\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    } else {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.author_discord_id = ${authorId}\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    }\r\n  } else if (status && status !== 'all') {\r\n    if (query) {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.status = ${status}\r\n        AND (r.incident_id ILIKE ${'%' + query + '%'} OR r.patient_letter ILIKE ${'%' + query + '%'} OR r.author_callsign ILIKE ${'%' + query + '%'})\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    } else {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.status = ${status}\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    }\r\n  } else {\r\n    if (query) {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.incident_id ILIKE ${'%' + query + '%'} OR r.patient_letter ILIKE ${'%' + query + '%'} OR r.author_callsign ILIKE ${'%' + query + '%'}\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    } else {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    }\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n// Admin: Get all users\r\nexport async function getAllUsers() {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT * FROM users \r\n    ORDER BY last_login DESC\r\n  `;\r\n  \r\n  return result;\r\n}\r\n\r\n// Admin: Force delete any ePRF (even complete ones)\r\nexport async function adminDeleteEPRFRecord(incidentId: string, patientLetter: string) {\r\n  const sql = getDb();\r\n  \r\n  // Delete data first\r\n  await sql`\r\n    DELETE FROM eprf_data \r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n  `;\r\n  \r\n  // Then delete the record (no status check)\r\n  const result = await sql`\r\n    DELETE FROM eprf_records \r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0] || null;\r\n}\r\n\r\n// Admin: Update ePRF record\r\nexport async function adminUpdateEPRFRecord(\r\n  incidentId: string, \r\n  patientLetter: string,\r\n  updates: {\r\n    status?: string;\r\n    author_discord_id?: string;\r\n    author_callsign?: string;\r\n  }\r\n) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    UPDATE eprf_records \r\n    SET \r\n      status = COALESCE(${updates.status}, status),\r\n      author_discord_id = COALESCE(${updates.author_discord_id}, author_discord_id),\r\n      author_callsign = COALESCE(${updates.author_callsign}, author_callsign),\r\n      updated_at = CURRENT_TIMESTAMP\r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0];\r\n}\r\n"],"names":["module","exports","require","runtime","GET","request","searchParams","URL","url","discordId","get","activeOnly","user","getUser","Response","json","success","error","status","users","getActiveUsers","console","message","POST","discordUsername","callsign","vehicle","upsertUser","routeModule","module_compiled","AppRouteRouteModule","definition","kind","route_kind","x","APP_ROUTE","page","pathname","filename","bundlePath","resolvedPagePath","nextConfigOutput","userland","route_namespaceObject","requestAsyncStorage","staticGenerationAsyncStorage","serverHooks","originalPathname","patchFetch","patch_fetch","XH","ComponentMod","route_next_edge_ssr_entry_namespaceObject","next_edge_app_route_loaderabsolutePagePath_private_next_app_dir_2Fapi_2Fusers_2Froute_js_page_2Fapi_2Fusers_2Froute_appDirLoader_bmV4dC1hcHAtbG9hZGVyP25hbWU9YXBwJTJGYXBpJTJGdXNlcnMlMkZyb3V0ZSZwYWdlPSUyRmFwaSUyRnVzZXJzJTJGcm91dGUmcGFnZVBhdGg9cHJpdmF0ZS1uZXh0LWFwcC1kaXIlMkZhcGklMkZ1c2VycyUyRnJvdXRlLmpzJmFwcERpcj1DJTNBJTVDVXNlcnMlNUNUb2J5JTVDRG93bmxvYWRzJTVDbm9kZS12MjQuMTEuMS13aW4teDY0JTVDYXBwMTIzJTVDYXBwJmFwcFBhdGhzPSUyRmFwaSUyRnVzZXJzJTJGcm91dGUmcGFnZUV4dGVuc2lvbnM9dHN4JnBhZ2VFeHRlbnNpb25zPXRzJnBhZ2VFeHRlbnNpb25zPWpzeCZwYWdlRXh0ZW5zaW9ucz1qcyZiYXNlUGF0aD0mYXNzZXRQcmVmaXg9Jm5leHRDb25maWdPdXRwdXQ9JnByZWZlcnJlZFJlZ2lvbj0mbWlkZGxld2FyZUNvbmZpZz1lMzAlM0Qh_nextConfigOutput_preferredRegion_middlewareConfig_e30_3D_","edge_route_module_wrapper","a","wrap","getDb","process","env","DATABASE_URL","neon","initializeDatabase","sql","createEPRFRecord","incidentId","patientLetter","authorDiscordId","authorCallsign","fleetId","result","getEPRFRecord","markEPRFComplete","deleteEPRFRecord","transferEPRF","newAuthorDiscordId","newAuthorCallsign","saveEPRFData","section","data","JSON","stringify","getEPRFData","getAllEPRFData","dataObj","row","searchEPRFs","query","dateFrom","dateTo","getAllEPRFRecords","authorId","getAllUsers","adminDeleteEPRFRecord","adminUpdateEPRFRecord","updates","author_discord_id","author_callsign"],"sourceRoot":""}