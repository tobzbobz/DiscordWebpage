{"version":3,"file":"app/api/admin/records/route.js","mappings":"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","sources":["webpack://_N_E/external commonjs \"node:async_hooks\"","webpack://_N_E/external commonjs \"node:buffer\"","webpack://_N_E/./app/api/admin/records/route.js","webpack://_N_E/./app/api/admin/records/route.js?8608","webpack://_N_E/?5519","webpack://_N_E/./lib/db.ts"],"sourcesContent":["module.exports = require(\"node:async_hooks\");","module.exports = require(\"node:buffer\");","import { \r\n  getAllEPRFRecords, \r\n  getAllUsers,\r\n  adminDeleteEPRFRecord,\r\n  adminUpdateEPRFRecord,\r\n  transferEPRF\r\n} from '../../../../lib/db';\r\n\r\nexport const runtime = 'edge';\r\n\r\n// Admin Discord ID - only this user can access admin functions\r\nconst ADMIN_DISCORD_ID = '695765253612953651';\r\n\r\n// Verify admin access\r\nfunction isAdmin(discordId) {\r\n  return discordId === ADMIN_DISCORD_ID;\r\n}\r\n\r\n// GET - Fetch all ePRF records (admin only)\r\nexport async function GET(request) {\r\n  try {\r\n    const { searchParams } = new URL(request.url);\r\n    const discordId = searchParams.get('discordId');\r\n    const query = searchParams.get('query');\r\n    const status = searchParams.get('status');\r\n    const authorId = searchParams.get('authorId');\r\n    const type = searchParams.get('type');\r\n    \r\n    if (!isAdmin(discordId)) {\r\n      return Response.json({ success: false, error: 'Unauthorized' }, { status: 403 });\r\n    }\r\n    \r\n    if (type === 'users') {\r\n      const users = await getAllUsers();\r\n      return Response.json({ success: true, users });\r\n    }\r\n    \r\n    const records = await getAllEPRFRecords(query || undefined, status || undefined, authorId || undefined);\r\n    return Response.json({ success: true, records });\r\n  } catch (error) {\r\n    console.error('Admin GET error:', error);\r\n    return Response.json({ success: false, error: error.message }, { status: 500 });\r\n  }\r\n}\r\n\r\n// PUT - Update ePRF record (admin only)\r\nexport async function PUT(request) {\r\n  try {\r\n    const body = await request.json();\r\n    const { discordId, incidentId, patientLetter, action, newAuthorDiscordId, newAuthorCallsign, status } = body;\r\n    \r\n    if (!isAdmin(discordId)) {\r\n      return Response.json({ success: false, error: 'Unauthorized' }, { status: 403 });\r\n    }\r\n    \r\n    if (!incidentId || !patientLetter) {\r\n      return Response.json({ success: false, error: 'Missing incidentId or patientLetter' }, { status: 400 });\r\n    }\r\n    \r\n    let record;\r\n    \r\n    if (action === 'transfer') {\r\n      record = await transferEPRF(incidentId, patientLetter, newAuthorDiscordId, newAuthorCallsign);\r\n    } else if (action === 'updateStatus') {\r\n      record = await adminUpdateEPRFRecord(incidentId, patientLetter, { status });\r\n    } else {\r\n      record = await adminUpdateEPRFRecord(incidentId, patientLetter, body.updates || {});\r\n    }\r\n    \r\n    return Response.json({ success: true, record });\r\n  } catch (error) {\r\n    console.error('Admin PUT error:', error);\r\n    return Response.json({ success: false, error: error.message }, { status: 500 });\r\n  }\r\n}\r\n\r\n// DELETE - Delete any ePRF record (admin only)\r\nexport async function DELETE(request) {\r\n  try {\r\n    const body = await request.json();\r\n    const { discordId, incidentId, patientLetter } = body;\r\n    \r\n    if (!isAdmin(discordId)) {\r\n      return Response.json({ success: false, error: 'Unauthorized' }, { status: 403 });\r\n    }\r\n    \r\n    if (!incidentId || !patientLetter) {\r\n      return Response.json({ success: false, error: 'Missing incidentId or patientLetter' }, { status: 400 });\r\n    }\r\n    \r\n    const deleted = await adminDeleteEPRFRecord(incidentId, patientLetter);\r\n    return Response.json({ success: true, deleted });\r\n  } catch (error) {\r\n    console.error('Admin DELETE error:', error);\r\n    return Response.json({ success: false, error: error.message }, { status: 500 });\r\n  }\r\n}\r\n","import { AppRouteRouteModule } from \"next/dist/server/future/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/server/future/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/server/lib/patch-fetch\";\nimport * as userland from \"C:\\\\Users\\\\Toby\\\\Downloads\\\\node-v24.11.1-win-x64\\\\app123\\\\app\\\\api\\\\admin\\\\records\\\\route.js\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/admin/records/route\",\n        pathname: \"/api/admin/records\",\n        filename: \"route\",\n        bundlePath: \"app/api/admin/records/route\"\n    },\n    resolvedPagePath: \"C:\\\\Users\\\\Toby\\\\Downloads\\\\node-v24.11.1-win-x64\\\\app123\\\\app\\\\api\\\\admin\\\\records\\\\route.js\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks } = routeModule;\nconst originalPathname = \"/api/admin/records/route\";\nfunction patchFetch() {\n    return _patchFetch({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\nexport { routeModule, requestAsyncStorage, staticGenerationAsyncStorage, serverHooks, originalPathname, patchFetch,  };\n\n//# sourceMappingURL=app-route.js.map","import { EdgeRouteModuleWrapper } from \"next/dist/server/web/edge-route-module-wrapper\";\n// Import the userland code.\nimport * as module from \"next-app-loader?name=app%2Fapi%2Fadmin%2Frecords%2Froute&page=%2Fapi%2Fadmin%2Frecords%2Froute&pagePath=private-next-app-dir%2Fapi%2Fadmin%2Frecords%2Froute.js&appDir=C%3A%5CUsers%5CToby%5CDownloads%5Cnode-v24.11.1-win-x64%5Capp123%5Capp&appPaths=%2Fapi%2Fadmin%2Frecords%2Froute&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!private-next-app-dir/api/admin/records/route.js?__next_edge_ssr_entry__\";\nexport const ComponentMod = module;\nexport default EdgeRouteModuleWrapper.wrap(module.routeModule);\n\n//# sourceMappingURL=edge-app-route.js.map","import { neon } from '@neondatabase/serverless';\r\n\r\n// Get the database connection\r\nexport function getDb() {\r\n  if (!process.env.DATABASE_URL) {\r\n    throw new Error('DATABASE_URL environment variable is not set');\r\n  }\r\n  return neon(process.env.DATABASE_URL);\r\n}\r\n\r\n// Initialize database tables\r\nexport async function initializeDatabase() {\r\n  const sql = getDb();\r\n  \r\n  // Create users table\r\n  await sql`\r\n    CREATE TABLE IF NOT EXISTS users (\r\n      id SERIAL PRIMARY KEY,\r\n      discord_id VARCHAR(255) UNIQUE NOT NULL,\r\n      discord_username VARCHAR(255),\r\n      callsign VARCHAR(100),\r\n      vehicle VARCHAR(100),\r\n      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n      last_login TIMESTAMP DEFAULT CURRENT_TIMESTAMP\r\n    )\r\n  `;\r\n  \r\n  // Create eprf_records table (main ePRF tracking)\r\n  await sql`\r\n    CREATE TABLE IF NOT EXISTS eprf_records (\r\n      id SERIAL PRIMARY KEY,\r\n      incident_id VARCHAR(255) NOT NULL,\r\n      patient_letter CHAR(1) NOT NULL,\r\n      status VARCHAR(20) DEFAULT 'incomplete',\r\n      author_discord_id VARCHAR(255) NOT NULL,\r\n      author_callsign VARCHAR(100),\r\n      fleet_id VARCHAR(100),\r\n      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n      submitted_at TIMESTAMP,\r\n      UNIQUE(incident_id, patient_letter)\r\n    )\r\n  `;\r\n  \r\n  // Create eprf_data table (stores all form data as JSON)\r\n  await sql`\r\n    CREATE TABLE IF NOT EXISTS eprf_data (\r\n      id SERIAL PRIMARY KEY,\r\n      incident_id VARCHAR(255) NOT NULL,\r\n      patient_letter CHAR(1) NOT NULL,\r\n      section VARCHAR(50) NOT NULL,\r\n      data JSONB NOT NULL,\r\n      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n      UNIQUE(incident_id, patient_letter, section)\r\n    )\r\n  `;\r\n  \r\n  // Create indexes for faster queries\r\n  await sql`CREATE INDEX IF NOT EXISTS idx_eprf_records_author ON eprf_records(author_discord_id)`;\r\n  await sql`CREATE INDEX IF NOT EXISTS idx_eprf_records_status ON eprf_records(status)`;\r\n  await sql`CREATE INDEX IF NOT EXISTS idx_eprf_data_incident ON eprf_data(incident_id, patient_letter)`;\r\n  \r\n  return { success: true };\r\n}\r\n\r\n// ePRF Record operations\r\nexport async function createEPRFRecord(\r\n  incidentId: string,\r\n  patientLetter: string,\r\n  authorDiscordId: string,\r\n  authorCallsign: string,\r\n  fleetId: string\r\n) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    INSERT INTO eprf_records (incident_id, patient_letter, author_discord_id, author_callsign, fleet_id)\r\n    VALUES (${incidentId}, ${patientLetter}, ${authorDiscordId}, ${authorCallsign}, ${fleetId})\r\n    ON CONFLICT (incident_id, patient_letter) \r\n    DO UPDATE SET updated_at = CURRENT_TIMESTAMP\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0];\r\n}\r\n\r\nexport async function getEPRFRecord(incidentId: string, patientLetter: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT * FROM eprf_records \r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n  `;\r\n  \r\n  return result[0] || null;\r\n}\r\n\r\nexport async function getEPRFRecordsByUser(discordId: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT * FROM eprf_records \r\n    WHERE author_discord_id = ${discordId}\r\n    ORDER BY created_at DESC\r\n  `;\r\n  \r\n  return result;\r\n}\r\n\r\nexport async function getEPRFRecordsByStatus(discordId: string, status: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT * FROM eprf_records \r\n    WHERE author_discord_id = ${discordId} AND status = ${status}\r\n    ORDER BY created_at DESC\r\n  `;\r\n  \r\n  return result;\r\n}\r\n\r\nexport async function markEPRFComplete(incidentId: string, patientLetter: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    UPDATE eprf_records \r\n    SET status = 'complete', submitted_at = CURRENT_TIMESTAMP, updated_at = CURRENT_TIMESTAMP\r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0];\r\n}\r\n\r\nexport async function deleteEPRFRecord(incidentId: string, patientLetter: string) {\r\n  const sql = getDb();\r\n  \r\n  // Delete data first (foreign key would normally handle this)\r\n  await sql`\r\n    DELETE FROM eprf_data \r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n  `;\r\n  \r\n  // Then delete the record\r\n  const result = await sql`\r\n    DELETE FROM eprf_records \r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n    AND status = 'incomplete'\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0] || null;\r\n}\r\n\r\nexport async function transferEPRF(\r\n  incidentId: string,\r\n  patientLetter: string,\r\n  newAuthorDiscordId: string,\r\n  newAuthorCallsign: string\r\n) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    UPDATE eprf_records \r\n    SET author_discord_id = ${newAuthorDiscordId}, \r\n        author_callsign = ${newAuthorCallsign},\r\n        updated_at = CURRENT_TIMESTAMP\r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0];\r\n}\r\n\r\n// ePRF Data operations (form data)\r\nexport async function saveEPRFData(\r\n  incidentId: string,\r\n  patientLetter: string,\r\n  section: string,\r\n  data: any\r\n) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    INSERT INTO eprf_data (incident_id, patient_letter, section, data)\r\n    VALUES (${incidentId}, ${patientLetter}, ${section}, ${JSON.stringify(data)})\r\n    ON CONFLICT (incident_id, patient_letter, section) \r\n    DO UPDATE SET data = ${JSON.stringify(data)}, updated_at = CURRENT_TIMESTAMP\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0];\r\n}\r\n\r\nexport async function getEPRFData(incidentId: string, patientLetter: string, section: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT data FROM eprf_data \r\n    WHERE incident_id = ${incidentId} \r\n    AND patient_letter = ${patientLetter} \r\n    AND section = ${section}\r\n  `;\r\n  \r\n  return result[0]?.data || null;\r\n}\r\n\r\nexport async function getAllEPRFData(incidentId: string, patientLetter: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT section, data FROM eprf_data \r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n  `;\r\n  \r\n  // Convert to object with section names as keys\r\n  const dataObj: { [key: string]: any } = {};\r\n  for (const row of result) {\r\n    dataObj[row.section] = row.data;\r\n  }\r\n  \r\n  return dataObj;\r\n}\r\n\r\n// User operations\r\nexport async function upsertUser(\r\n  discordId: string,\r\n  discordUsername: string,\r\n  callsign: string,\r\n  vehicle: string\r\n) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    INSERT INTO users (discord_id, discord_username, callsign, vehicle, last_login)\r\n    VALUES (${discordId}, ${discordUsername}, ${callsign}, ${vehicle}, CURRENT_TIMESTAMP)\r\n    ON CONFLICT (discord_id) \r\n    DO UPDATE SET \r\n      discord_username = ${discordUsername},\r\n      callsign = ${callsign},\r\n      vehicle = ${vehicle},\r\n      last_login = CURRENT_TIMESTAMP\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0];\r\n}\r\n\r\nexport async function getActiveUsers() {\r\n  const sql = getDb();\r\n  \r\n  // Get users who logged in within the last 24 hours\r\n  const result = await sql`\r\n    SELECT * FROM users \r\n    WHERE last_login > NOW() - INTERVAL '24 hours'\r\n    ORDER BY last_login DESC\r\n  `;\r\n  \r\n  return result;\r\n}\r\n\r\nexport async function getUser(discordId: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT * FROM users WHERE discord_id = ${discordId}\r\n  `;\r\n  \r\n  return result[0] || null;\r\n}\r\n\r\n// Search and filter ePRFs\r\nexport async function searchEPRFs(\r\n  discordId: string,\r\n  query?: string,\r\n  status?: string,\r\n  dateFrom?: string,\r\n  dateTo?: string\r\n) {\r\n  const sql = getDb();\r\n  \r\n  let result;\r\n  \r\n  if (status && status !== 'all') {\r\n    if (query) {\r\n      result = await sql`\r\n        SELECT * FROM eprf_records \r\n        WHERE author_discord_id = ${discordId}\r\n        AND status = ${status}\r\n        AND (incident_id ILIKE ${'%' + query + '%'} OR patient_letter ILIKE ${'%' + query + '%'})\r\n        ORDER BY created_at DESC\r\n      `;\r\n    } else {\r\n      result = await sql`\r\n        SELECT * FROM eprf_records \r\n        WHERE author_discord_id = ${discordId}\r\n        AND status = ${status}\r\n        ORDER BY created_at DESC\r\n      `;\r\n    }\r\n  } else {\r\n    if (query) {\r\n      result = await sql`\r\n        SELECT * FROM eprf_records \r\n        WHERE author_discord_id = ${discordId}\r\n        AND (incident_id ILIKE ${'%' + query + '%'} OR patient_letter ILIKE ${'%' + query + '%'})\r\n        ORDER BY created_at DESC\r\n      `;\r\n    } else {\r\n      result = await sql`\r\n        SELECT * FROM eprf_records \r\n        WHERE author_discord_id = ${discordId}\r\n        ORDER BY created_at DESC\r\n      `;\r\n    }\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n// Admin functions - get ALL ePRF records\r\nexport async function getAllEPRFRecords(\r\n  query?: string,\r\n  status?: string,\r\n  authorId?: string\r\n) {\r\n  const sql = getDb();\r\n  \r\n  let result;\r\n  \r\n  // Build query based on filters\r\n  if (authorId && status && status !== 'all') {\r\n    if (query) {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.author_discord_id = ${authorId}\r\n        AND r.status = ${status}\r\n        AND (r.incident_id ILIKE ${'%' + query + '%'} OR r.patient_letter ILIKE ${'%' + query + '%'} OR r.author_callsign ILIKE ${'%' + query + '%'})\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    } else {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.author_discord_id = ${authorId}\r\n        AND r.status = ${status}\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    }\r\n  } else if (authorId) {\r\n    if (query) {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.author_discord_id = ${authorId}\r\n        AND (r.incident_id ILIKE ${'%' + query + '%'} OR r.patient_letter ILIKE ${'%' + query + '%'} OR r.author_callsign ILIKE ${'%' + query + '%'})\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    } else {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.author_discord_id = ${authorId}\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    }\r\n  } else if (status && status !== 'all') {\r\n    if (query) {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.status = ${status}\r\n        AND (r.incident_id ILIKE ${'%' + query + '%'} OR r.patient_letter ILIKE ${'%' + query + '%'} OR r.author_callsign ILIKE ${'%' + query + '%'})\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    } else {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.status = ${status}\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    }\r\n  } else {\r\n    if (query) {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.incident_id ILIKE ${'%' + query + '%'} OR r.patient_letter ILIKE ${'%' + query + '%'} OR r.author_callsign ILIKE ${'%' + query + '%'}\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    } else {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    }\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n// Admin: Get all users\r\nexport async function getAllUsers() {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT * FROM users \r\n    ORDER BY last_login DESC\r\n  `;\r\n  \r\n  return result;\r\n}\r\n\r\n// Admin: Force delete any ePRF (even complete ones)\r\nexport async function adminDeleteEPRFRecord(incidentId: string, patientLetter: string) {\r\n  const sql = getDb();\r\n  \r\n  // Delete data first\r\n  await sql`\r\n    DELETE FROM eprf_data \r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n  `;\r\n  \r\n  // Then delete the record (no status check)\r\n  const result = await sql`\r\n    DELETE FROM eprf_records \r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0] || null;\r\n}\r\n\r\n// Admin: Update ePRF record\r\nexport async function adminUpdateEPRFRecord(\r\n  incidentId: string, \r\n  patientLetter: string,\r\n  updates: {\r\n    status?: string;\r\n    author_discord_id?: string;\r\n    author_callsign?: string;\r\n  }\r\n) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    UPDATE eprf_records \r\n    SET \r\n      status = COALESCE(${updates.status}, status),\r\n      author_discord_id = COALESCE(${updates.author_discord_id}, author_discord_id),\r\n      author_callsign = COALESCE(${updates.author_callsign}, author_callsign),\r\n      updated_at = CURRENT_TIMESTAMP\r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0];\r\n}\r\n"],"names":["module","exports","require","runtime","isAdmin","discordId","GET","request","searchParams","URL","url","get","query","status","authorId","type","Response","json","success","error","users","getAllUsers","records","getAllEPRFRecords","undefined","console","message","PUT","record","body","incidentId","patientLetter","action","newAuthorDiscordId","newAuthorCallsign","transferEPRF","adminUpdateEPRFRecord","updates","DELETE","deleted","adminDeleteEPRFRecord","routeModule","module_compiled","AppRouteRouteModule","definition","kind","route_kind","x","APP_ROUTE","page","pathname","filename","bundlePath","resolvedPagePath","nextConfigOutput","userland","route_namespaceObject","requestAsyncStorage","staticGenerationAsyncStorage","serverHooks","originalPathname","patchFetch","patch_fetch","XH","ComponentMod","route_next_edge_ssr_entry_namespaceObject","next_edge_app_route_loaderabsolutePagePath_private_next_app_dir_2Fapi_2Fadmin_2Frecords_2Froute_js_page_2Fapi_2Fadmin_2Frecords_2Froute_appDirLoader_bmV4dC1hcHAtbG9hZGVyP25hbWU9YXBwJTJGYXBpJTJGYWRtaW4lMkZyZWNvcmRzJTJGcm91dGUmcGFnZT0lMkZhcGklMkZhZG1pbiUyRnJlY29yZHMlMkZyb3V0ZSZwYWdlUGF0aD1wcml2YXRlLW5leHQtYXBwLWRpciUyRmFwaSUyRmFkbWluJTJGcmVjb3JkcyUyRnJvdXRlLmpzJmFwcERpcj1DJTNBJTVDVXNlcnMlNUNUb2J5JTVDRG93bmxvYWRzJTVDbm9kZS12MjQuMTEuMS13aW4teDY0JTVDYXBwMTIzJTVDYXBwJmFwcFBhdGhzPSUyRmFwaSUyRmFkbWluJTJGcmVjb3JkcyUyRnJvdXRlJnBhZ2VFeHRlbnNpb25zPXRzeCZwYWdlRXh0ZW5zaW9ucz10cyZwYWdlRXh0ZW5zaW9ucz1qc3gmcGFnZUV4dGVuc2lvbnM9anMmYmFzZVBhdGg9JmFzc2V0UHJlZml4PSZuZXh0Q29uZmlnT3V0cHV0PSZwcmVmZXJyZWRSZWdpb249Jm1pZGRsZXdhcmVDb25maWc9ZTMwJTNEIQ_3D_3D_nextConfigOutput_preferredRegion_middlewareConfig_e30_3D_","edge_route_module_wrapper","a","wrap","getDb","process","env","DATABASE_URL","neon","initializeDatabase","sql","createEPRFRecord","authorDiscordId","authorCallsign","fleetId","result","getEPRFRecord","markEPRFComplete","deleteEPRFRecord","saveEPRFData","section","data","JSON","stringify","getEPRFData","getAllEPRFData","dataObj","row","upsertUser","discordUsername","callsign","vehicle","getActiveUsers","getUser","searchEPRFs","dateFrom","dateTo","author_discord_id","author_callsign"],"sourceRoot":""}