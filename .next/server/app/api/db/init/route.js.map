{"version":3,"file":"app/api/db/init/route.js","mappings":"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","sources":["webpack://_N_E/external commonjs \"node:async_hooks\"","webpack://_N_E/external commonjs \"node:buffer\"","webpack://_N_E/./app/api/db/init/route.js","webpack://_N_E/./app/api/db/init/route.js?e57e","webpack://_N_E/?5ac1","webpack://_N_E/./lib/db.ts"],"sourcesContent":["module.exports = require(\"node:async_hooks\");","module.exports = require(\"node:buffer\");","import { initializeDatabase } from '../../../../lib/db';\r\n\r\nexport const runtime = 'edge';\r\n\r\nexport async function GET(request) {\r\n  try {\r\n    await initializeDatabase();\r\n    return Response.json({ success: true, message: 'Database initialized successfully' });\r\n  } catch (error) {\r\n    console.error('Database initialization error:', error);\r\n    return Response.json({ success: false, error: error.message }, { status: 500 });\r\n  }\r\n}\r\n","import { AppRouteRouteModule } from \"next/dist/server/future/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/server/future/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/server/lib/patch-fetch\";\nimport * as userland from \"C:\\\\Users\\\\Toby\\\\Downloads\\\\node-v24.11.1-win-x64\\\\app123\\\\app\\\\api\\\\db\\\\init\\\\route.js\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/db/init/route\",\n        pathname: \"/api/db/init\",\n        filename: \"route\",\n        bundlePath: \"app/api/db/init/route\"\n    },\n    resolvedPagePath: \"C:\\\\Users\\\\Toby\\\\Downloads\\\\node-v24.11.1-win-x64\\\\app123\\\\app\\\\api\\\\db\\\\init\\\\route.js\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { requestAsyncStorage, staticGenerationAsyncStorage, serverHooks } = routeModule;\nconst originalPathname = \"/api/db/init/route\";\nfunction patchFetch() {\n    return _patchFetch({\n        serverHooks,\n        staticGenerationAsyncStorage\n    });\n}\nexport { routeModule, requestAsyncStorage, staticGenerationAsyncStorage, serverHooks, originalPathname, patchFetch,  };\n\n//# sourceMappingURL=app-route.js.map","import { EdgeRouteModuleWrapper } from \"next/dist/server/web/edge-route-module-wrapper\";\n// Import the userland code.\nimport * as module from \"next-app-loader?name=app%2Fapi%2Fdb%2Finit%2Froute&page=%2Fapi%2Fdb%2Finit%2Froute&pagePath=private-next-app-dir%2Fapi%2Fdb%2Finit%2Froute.js&appDir=C%3A%5CUsers%5CToby%5CDownloads%5Cnode-v24.11.1-win-x64%5Capp123%5Capp&appPaths=%2Fapi%2Fdb%2Finit%2Froute&pageExtensions=tsx&pageExtensions=ts&pageExtensions=jsx&pageExtensions=js&basePath=&assetPrefix=&nextConfigOutput=&preferredRegion=&middlewareConfig=e30%3D!private-next-app-dir/api/db/init/route.js?__next_edge_ssr_entry__\";\nexport const ComponentMod = module;\nexport default EdgeRouteModuleWrapper.wrap(module.routeModule);\n\n//# sourceMappingURL=edge-app-route.js.map","import { neon } from '@neondatabase/serverless';\r\n\r\n// Get the database connection\r\nexport function getDb() {\r\n  if (!process.env.DATABASE_URL) {\r\n    throw new Error('DATABASE_URL environment variable is not set');\r\n  }\r\n  return neon(process.env.DATABASE_URL);\r\n}\r\n\r\n// Initialize database tables\r\nexport async function initializeDatabase() {\r\n  const sql = getDb();\r\n  \r\n  // Create users table\r\n  await sql`\r\n    CREATE TABLE IF NOT EXISTS users (\r\n      id SERIAL PRIMARY KEY,\r\n      discord_id VARCHAR(255) UNIQUE NOT NULL,\r\n      discord_username VARCHAR(255),\r\n      callsign VARCHAR(100),\r\n      vehicle VARCHAR(100),\r\n      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n      last_login TIMESTAMP DEFAULT CURRENT_TIMESTAMP\r\n    )\r\n  `;\r\n  \r\n  // Create eprf_records table (main ePRF tracking)\r\n  await sql`\r\n    CREATE TABLE IF NOT EXISTS eprf_records (\r\n      id SERIAL PRIMARY KEY,\r\n      incident_id VARCHAR(255) NOT NULL,\r\n      patient_letter CHAR(1) NOT NULL,\r\n      status VARCHAR(20) DEFAULT 'incomplete',\r\n      author_discord_id VARCHAR(255) NOT NULL,\r\n      author_callsign VARCHAR(100),\r\n      fleet_id VARCHAR(100),\r\n      created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n      submitted_at TIMESTAMP,\r\n      UNIQUE(incident_id, patient_letter)\r\n    )\r\n  `;\r\n  \r\n  // Create eprf_data table (stores all form data as JSON)\r\n  await sql`\r\n    CREATE TABLE IF NOT EXISTS eprf_data (\r\n      id SERIAL PRIMARY KEY,\r\n      incident_id VARCHAR(255) NOT NULL,\r\n      patient_letter CHAR(1) NOT NULL,\r\n      section VARCHAR(50) NOT NULL,\r\n      data JSONB NOT NULL,\r\n      updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\r\n      UNIQUE(incident_id, patient_letter, section)\r\n    )\r\n  `;\r\n  \r\n  // Create indexes for faster queries\r\n  await sql`CREATE INDEX IF NOT EXISTS idx_eprf_records_author ON eprf_records(author_discord_id)`;\r\n  await sql`CREATE INDEX IF NOT EXISTS idx_eprf_records_status ON eprf_records(status)`;\r\n  await sql`CREATE INDEX IF NOT EXISTS idx_eprf_data_incident ON eprf_data(incident_id, patient_letter)`;\r\n  \r\n  return { success: true };\r\n}\r\n\r\n// ePRF Record operations\r\nexport async function createEPRFRecord(\r\n  incidentId: string,\r\n  patientLetter: string,\r\n  authorDiscordId: string,\r\n  authorCallsign: string,\r\n  fleetId: string\r\n) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    INSERT INTO eprf_records (incident_id, patient_letter, author_discord_id, author_callsign, fleet_id)\r\n    VALUES (${incidentId}, ${patientLetter}, ${authorDiscordId}, ${authorCallsign}, ${fleetId})\r\n    ON CONFLICT (incident_id, patient_letter) \r\n    DO UPDATE SET updated_at = CURRENT_TIMESTAMP\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0];\r\n}\r\n\r\nexport async function getEPRFRecord(incidentId: string, patientLetter: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT * FROM eprf_records \r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n  `;\r\n  \r\n  return result[0] || null;\r\n}\r\n\r\nexport async function getEPRFRecordsByUser(discordId: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT * FROM eprf_records \r\n    WHERE author_discord_id = ${discordId}\r\n    ORDER BY created_at DESC\r\n  `;\r\n  \r\n  return result;\r\n}\r\n\r\nexport async function getEPRFRecordsByStatus(discordId: string, status: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT * FROM eprf_records \r\n    WHERE author_discord_id = ${discordId} AND status = ${status}\r\n    ORDER BY created_at DESC\r\n  `;\r\n  \r\n  return result;\r\n}\r\n\r\nexport async function markEPRFComplete(incidentId: string, patientLetter: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    UPDATE eprf_records \r\n    SET status = 'complete', submitted_at = CURRENT_TIMESTAMP, updated_at = CURRENT_TIMESTAMP\r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0];\r\n}\r\n\r\nexport async function deleteEPRFRecord(incidentId: string, patientLetter: string) {\r\n  const sql = getDb();\r\n  \r\n  // Delete data first (foreign key would normally handle this)\r\n  await sql`\r\n    DELETE FROM eprf_data \r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n  `;\r\n  \r\n  // Then delete the record\r\n  const result = await sql`\r\n    DELETE FROM eprf_records \r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n    AND status = 'incomplete'\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0] || null;\r\n}\r\n\r\nexport async function transferEPRF(\r\n  incidentId: string,\r\n  patientLetter: string,\r\n  newAuthorDiscordId: string,\r\n  newAuthorCallsign: string\r\n) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    UPDATE eprf_records \r\n    SET author_discord_id = ${newAuthorDiscordId}, \r\n        author_callsign = ${newAuthorCallsign},\r\n        updated_at = CURRENT_TIMESTAMP\r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0];\r\n}\r\n\r\n// ePRF Data operations (form data)\r\nexport async function saveEPRFData(\r\n  incidentId: string,\r\n  patientLetter: string,\r\n  section: string,\r\n  data: any\r\n) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    INSERT INTO eprf_data (incident_id, patient_letter, section, data)\r\n    VALUES (${incidentId}, ${patientLetter}, ${section}, ${JSON.stringify(data)})\r\n    ON CONFLICT (incident_id, patient_letter, section) \r\n    DO UPDATE SET data = ${JSON.stringify(data)}, updated_at = CURRENT_TIMESTAMP\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0];\r\n}\r\n\r\nexport async function getEPRFData(incidentId: string, patientLetter: string, section: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT data FROM eprf_data \r\n    WHERE incident_id = ${incidentId} \r\n    AND patient_letter = ${patientLetter} \r\n    AND section = ${section}\r\n  `;\r\n  \r\n  return result[0]?.data || null;\r\n}\r\n\r\nexport async function getAllEPRFData(incidentId: string, patientLetter: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT section, data FROM eprf_data \r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n  `;\r\n  \r\n  // Convert to object with section names as keys\r\n  const dataObj: { [key: string]: any } = {};\r\n  for (const row of result) {\r\n    dataObj[row.section] = row.data;\r\n  }\r\n  \r\n  return dataObj;\r\n}\r\n\r\n// User operations\r\nexport async function upsertUser(\r\n  discordId: string,\r\n  discordUsername: string,\r\n  callsign: string,\r\n  vehicle: string\r\n) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    INSERT INTO users (discord_id, discord_username, callsign, vehicle, last_login)\r\n    VALUES (${discordId}, ${discordUsername}, ${callsign}, ${vehicle}, CURRENT_TIMESTAMP)\r\n    ON CONFLICT (discord_id) \r\n    DO UPDATE SET \r\n      discord_username = ${discordUsername},\r\n      callsign = ${callsign},\r\n      vehicle = ${vehicle},\r\n      last_login = CURRENT_TIMESTAMP\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0];\r\n}\r\n\r\nexport async function getActiveUsers() {\r\n  const sql = getDb();\r\n  \r\n  // Get users who logged in within the last 24 hours\r\n  const result = await sql`\r\n    SELECT * FROM users \r\n    WHERE last_login > NOW() - INTERVAL '24 hours'\r\n    ORDER BY last_login DESC\r\n  `;\r\n  \r\n  return result;\r\n}\r\n\r\nexport async function getUser(discordId: string) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT * FROM users WHERE discord_id = ${discordId}\r\n  `;\r\n  \r\n  return result[0] || null;\r\n}\r\n\r\n// Search and filter ePRFs\r\nexport async function searchEPRFs(\r\n  discordId: string,\r\n  query?: string,\r\n  status?: string,\r\n  dateFrom?: string,\r\n  dateTo?: string\r\n) {\r\n  const sql = getDb();\r\n  \r\n  let result;\r\n  \r\n  if (status && status !== 'all') {\r\n    if (query) {\r\n      result = await sql`\r\n        SELECT * FROM eprf_records \r\n        WHERE author_discord_id = ${discordId}\r\n        AND status = ${status}\r\n        AND (incident_id ILIKE ${'%' + query + '%'} OR patient_letter ILIKE ${'%' + query + '%'})\r\n        ORDER BY created_at DESC\r\n      `;\r\n    } else {\r\n      result = await sql`\r\n        SELECT * FROM eprf_records \r\n        WHERE author_discord_id = ${discordId}\r\n        AND status = ${status}\r\n        ORDER BY created_at DESC\r\n      `;\r\n    }\r\n  } else {\r\n    if (query) {\r\n      result = await sql`\r\n        SELECT * FROM eprf_records \r\n        WHERE author_discord_id = ${discordId}\r\n        AND (incident_id ILIKE ${'%' + query + '%'} OR patient_letter ILIKE ${'%' + query + '%'})\r\n        ORDER BY created_at DESC\r\n      `;\r\n    } else {\r\n      result = await sql`\r\n        SELECT * FROM eprf_records \r\n        WHERE author_discord_id = ${discordId}\r\n        ORDER BY created_at DESC\r\n      `;\r\n    }\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n// Admin functions - get ALL ePRF records\r\nexport async function getAllEPRFRecords(\r\n  query?: string,\r\n  status?: string,\r\n  authorId?: string\r\n) {\r\n  const sql = getDb();\r\n  \r\n  let result;\r\n  \r\n  // Build query based on filters\r\n  if (authorId && status && status !== 'all') {\r\n    if (query) {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.author_discord_id = ${authorId}\r\n        AND r.status = ${status}\r\n        AND (r.incident_id ILIKE ${'%' + query + '%'} OR r.patient_letter ILIKE ${'%' + query + '%'} OR r.author_callsign ILIKE ${'%' + query + '%'})\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    } else {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.author_discord_id = ${authorId}\r\n        AND r.status = ${status}\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    }\r\n  } else if (authorId) {\r\n    if (query) {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.author_discord_id = ${authorId}\r\n        AND (r.incident_id ILIKE ${'%' + query + '%'} OR r.patient_letter ILIKE ${'%' + query + '%'} OR r.author_callsign ILIKE ${'%' + query + '%'})\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    } else {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.author_discord_id = ${authorId}\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    }\r\n  } else if (status && status !== 'all') {\r\n    if (query) {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.status = ${status}\r\n        AND (r.incident_id ILIKE ${'%' + query + '%'} OR r.patient_letter ILIKE ${'%' + query + '%'} OR r.author_callsign ILIKE ${'%' + query + '%'})\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    } else {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.status = ${status}\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    }\r\n  } else {\r\n    if (query) {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        WHERE r.incident_id ILIKE ${'%' + query + '%'} OR r.patient_letter ILIKE ${'%' + query + '%'} OR r.author_callsign ILIKE ${'%' + query + '%'}\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    } else {\r\n      result = await sql`\r\n        SELECT r.*, u.callsign as user_callsign, u.discord_username \r\n        FROM eprf_records r\r\n        LEFT JOIN users u ON r.author_discord_id = u.discord_id\r\n        ORDER BY r.created_at DESC\r\n      `;\r\n    }\r\n  }\r\n  \r\n  return result;\r\n}\r\n\r\n// Admin: Get all users\r\nexport async function getAllUsers() {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    SELECT * FROM users \r\n    ORDER BY last_login DESC\r\n  `;\r\n  \r\n  return result;\r\n}\r\n\r\n// Admin: Force delete any ePRF (even complete ones)\r\nexport async function adminDeleteEPRFRecord(incidentId: string, patientLetter: string) {\r\n  const sql = getDb();\r\n  \r\n  // Delete data first\r\n  await sql`\r\n    DELETE FROM eprf_data \r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n  `;\r\n  \r\n  // Then delete the record (no status check)\r\n  const result = await sql`\r\n    DELETE FROM eprf_records \r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0] || null;\r\n}\r\n\r\n// Admin: Update ePRF record\r\nexport async function adminUpdateEPRFRecord(\r\n  incidentId: string, \r\n  patientLetter: string,\r\n  updates: {\r\n    status?: string;\r\n    author_discord_id?: string;\r\n    author_callsign?: string;\r\n  }\r\n) {\r\n  const sql = getDb();\r\n  \r\n  const result = await sql`\r\n    UPDATE eprf_records \r\n    SET \r\n      status = COALESCE(${updates.status}, status),\r\n      author_discord_id = COALESCE(${updates.author_discord_id}, author_discord_id),\r\n      author_callsign = COALESCE(${updates.author_callsign}, author_callsign),\r\n      updated_at = CURRENT_TIMESTAMP\r\n    WHERE incident_id = ${incidentId} AND patient_letter = ${patientLetter}\r\n    RETURNING *\r\n  `;\r\n  \r\n  return result[0];\r\n}\r\n"],"names":["module","exports","require","runtime","GET","request","initializeDatabase","Response","json","success","message","error","console","status","routeModule","module_compiled","AppRouteRouteModule","definition","kind","route_kind","x","APP_ROUTE","page","pathname","filename","bundlePath","resolvedPagePath","nextConfigOutput","userland","route_namespaceObject","requestAsyncStorage","staticGenerationAsyncStorage","serverHooks","originalPathname","patchFetch","patch_fetch","XH","ComponentMod","route_next_edge_ssr_entry_namespaceObject","next_edge_app_route_loaderabsolutePagePath_private_next_app_dir_2Fapi_2Fdb_2Finit_2Froute_js_page_2Fapi_2Fdb_2Finit_2Froute_appDirLoader_bmV4dC1hcHAtbG9hZGVyP25hbWU9YXBwJTJGYXBpJTJGZGIlMkZpbml0JTJGcm91dGUmcGFnZT0lMkZhcGklMkZkYiUyRmluaXQlMkZyb3V0ZSZwYWdlUGF0aD1wcml2YXRlLW5leHQtYXBwLWRpciUyRmFwaSUyRmRiJTJGaW5pdCUyRnJvdXRlLmpzJmFwcERpcj1DJTNBJTVDVXNlcnMlNUNUb2J5JTVDRG93bmxvYWRzJTVDbm9kZS12MjQuMTEuMS13aW4teDY0JTVDYXBwMTIzJTVDYXBwJmFwcFBhdGhzPSUyRmFwaSUyRmRiJTJGaW5pdCUyRnJvdXRlJnBhZ2VFeHRlbnNpb25zPXRzeCZwYWdlRXh0ZW5zaW9ucz10cyZwYWdlRXh0ZW5zaW9ucz1qc3gmcGFnZUV4dGVuc2lvbnM9anMmYmFzZVBhdGg9JmFzc2V0UHJlZml4PSZuZXh0Q29uZmlnT3V0cHV0PSZwcmVmZXJyZWRSZWdpb249Jm1pZGRsZXdhcmVDb25maWc9ZTMwJTNEIQ_3D_3D_nextConfigOutput_preferredRegion_middlewareConfig_e30_3D_","edge_route_module_wrapper","a","wrap","getDb","process","env","DATABASE_URL","neon","sql","createEPRFRecord","incidentId","patientLetter","authorDiscordId","authorCallsign","fleetId","result","getEPRFRecord","markEPRFComplete","deleteEPRFRecord","transferEPRF","newAuthorDiscordId","newAuthorCallsign","saveEPRFData","section","data","JSON","stringify","getEPRFData","getAllEPRFData","dataObj","row","upsertUser","discordId","discordUsername","callsign","vehicle","getActiveUsers","getUser","searchEPRFs","query","dateFrom","dateTo","getAllEPRFRecords","authorId","getAllUsers","adminDeleteEPRFRecord","adminUpdateEPRFRecord","updates","author_discord_id","author_callsign"],"sourceRoot":""}